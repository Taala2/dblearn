# Урок 11: Транзакции - Обеспечение целостности данных

## Введение в транзакции

Транзакция — это последовательность операций с базой данных, которая представляет собой логическую единицу работы. Транзакции обеспечивают надежность и целостность данных, особенно в многопользовательской среде или при выполнении сложных операций, состоящих из нескольких шагов.

Основная идея транзакций: либо все операции в транзакции выполняются успешно, либо ни одна из них не выполняется, что предотвращает частичное изменение данных и сохраняет базу данных в согласованном состоянии.

## Свойства транзакций (ACID)

Транзакции характеризуются четырьмя основными свойствами, известными под аббревиатурой ACID:

### Атомарность (Atomicity)

Атомарность гарантирует, что все операции в транзакции выполняются как единое целое. Если какая-либо операция в транзакции не может быть выполнена, вся транзакция отменяется, и база данных возвращается в состояние, в котором она была до начала транзакции.

### Согласованность (Consistency)

Согласованность обеспечивает, что транзакция переводит базу данных из одного согласованного состояния в другое. Все ограничения целостности (первичные ключи, внешние ключи, уникальность и т.д.) должны выполняться до и после транзакции.

### Изолированность (Isolation)

Изолированность гарантирует, что операции внутри транзакции скрыты от других транзакций до завершения. Это предотвращает влияние незавершенных транзакций на другие транзакции, выполняющиеся одновременно.

### Долговечность (Durability)

Долговечность обеспечивает, что после успешного завершения транзакции (COMMIT) все изменения становятся постоянными и сохраняются в базе данных даже в случае сбоя системы.

## Управление транзакциями

### Начало транзакции

Транзакция начинается с оператора BEGIN TRANSACTION (или просто BEGIN):

```sql
BEGIN; -- или BEGIN TRANSACTION;
```

### Фиксация транзакции

Для успешного завершения транзакции и сохранения всех изменений используется оператор COMMIT:

```sql
COMMIT;
```

### Отмена транзакции

Если необходимо отменить транзакцию и все изменения, которые были сделаны в ее рамках, используется оператор ROLLBACK:

```sql
ROLLBACK;
```

### Точки сохранения

Точки сохранения (SAVEPOINT) позволяют создавать контрольные точки внутри транзакции, к которым можно откатиться без отмены всей транзакции:

```sql
BEGIN;
-- Некоторые операции
SAVEPOINT point1;
-- Еще операции
ROLLBACK TO point1; -- Откат к точке сохранения
-- Продолжение транзакции
COMMIT;
```

## Пример использования транзакций

### Перевод денег между счетами

Классический пример использования транзакций — перевод денег между банковскими счетами:

```sql
BEGIN;

-- Снимаем деньги с первого счета
UPDATE accounts
SET balance = balance - 1000
WHERE id = 1;

-- Проверяем, что баланс не стал отрицательным
SELECT balance FROM accounts WHERE id = 1;
-- Если баланс отрицательный, выполняем ROLLBACK

-- Пополняем второй счет
UPDATE accounts
SET balance = balance + 1000
WHERE id = 2;

COMMIT;
```

Если что-то пойдет не так (например, недостаточно средств на первом счете или второй счет не существует), вся транзакция будет отменена, и деньги не будут сняты с первого счета.

## Уровни изоляции транзакций

Стандарт SQL определяет четыре уровня изоляции транзакций, которые определяют, как транзакции взаимодействуют друг с другом:

### READ UNCOMMITTED

Самый низкий уровень изоляции. Транзакция может видеть незафиксированные изменения, сделанные другими транзакциями ("грязное чтение").

```sql
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
BEGIN;
-- Операции
COMMIT;
```

### READ COMMITTED

Транзакция видит только зафиксированные изменения, сделанные другими транзакциями. Однако может возникнуть проблема "неповторяемого чтения", когда повторное чтение одних и тех же данных в рамках одной транзакции может дать разные результаты из-за фиксации изменений другими транзакциями.

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
-- Операции
COMMIT;
```

### REPEATABLE READ

Транзакция видит только те данные, которые были зафиксированы до начала транзакции, и все запросы в рамках одной транзакции видят одну и ту же версию данных. Однако может возникнуть проблема "фантомного чтения", когда результаты запросов могут включать новые строки, добавленные другими транзакциями.

```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
-- Операции
COMMIT;
```

### SERIALIZABLE

Самый высокий уровень изоляции. Транзакции полностью изолированы друг от друга, как если бы они выполнялись последовательно. Это предотвращает все проблемы параллельного выполнения, но может значительно снизить производительность.

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN;
-- Операции
COMMIT;
```

## Проблемы конкурентного доступа

При параллельном выполнении транзакций могут возникать следующие проблемы:

### Грязное чтение (Dirty Read)

Транзакция читает данные, которые были изменены другой незавершенной транзакцией. Если вторая транзакция будет отменена, первая транзакция будет работать с недействительными данными.

### Неповторяемое чтение (Non-repeatable Read)

Транзакция повторно читает данные, которые уже были прочитаны ранее, и обнаруживает, что данные были изменены другой завершенной транзакцией.

### Фантомное чтение (Phantom Read)

Транзакция выполняет запрос, возвращающий набор строк, удовлетворяющих условию. Другая транзакция вставляет новые строки, удовлетворяющие тому же условию. Если первая транзакция повторит запрос, она получит другой набор строк.

### Потерянное обновление (Lost Update)

Две транзакции читают одну и ту же строку, затем обе обновляют ее на основе прочитанного значения. Одно из обновлений "теряется", так как вторая транзакция не видит изменения, сделанные первой.

## Уровни изоляции и проблемы конкурентного доступа

| Уровень изоляции | Грязное чтение | Неповторяемое чтение | Фантомное чтение |
|------------------|----------------|----------------------|------------------|
| READ UNCOMMITTED | Возможно       | Возможно             | Возможно         |
| READ COMMITTED   | Не возможно    | Возможно             | Возможно         |
| REPEATABLE READ  | Не возможно    | Не возможно          | Возможно*        |
| SERIALIZABLE     | Не возможно    | Не возможно          | Не возможно      |

* В некоторых СУБД (например, MySQL InnoDB) уровень REPEATABLE READ также предотвращает фантомное чтение.

## Блокировки

Для обеспечения изоляции транзакций СУБД используют механизмы блокировок:

### Разделяемая блокировка (Shared Lock)

Разделяемая блокировка позволяет другим транзакциям читать данные, но не изменять их. Несколько транзакций могут одновременно держать разделяемую блокировку на одних и тех же данных.

```sql
-- В некоторых СУБД можно явно установить разделяемую блокировку
SELECT * FROM accounts WHERE id = 1 FOR SHARE;
```

### Исключительная блокировка (Exclusive Lock)

Исключительная блокировка позволяет транзакции изменять данные и предотвращает чтение и изменение этих данных другими транзакциями.

```sql
-- В некоторых СУБД можно явно установить исключительную блокировку
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;
```

### Взаимоблокировка (Deadlock)

Взаимоблокировка возникает, когда две или более транзакции ждут освобождения ресурсов, занятых друг другом. СУБД обычно обнаруживает взаимоблокировки и автоматически отменяет одну из транзакций.

## Транзакции в разных СУБД

### PostgreSQL

PostgreSQL поддерживает все стандартные операции и уровни изоляции транзакций. По умолчанию используется уровень READ COMMITTED.

```sql
-- Установка уровня изоляции для сессии
SET SESSION CHARACTERISTICS AS TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

### MySQL

MySQL (с движком InnoDB) поддерживает транзакции и все уровни изоляции. По умолчанию используется уровень REPEATABLE READ.

```sql
-- Установка уровня изоляции для сессии
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

### SQLite

SQLite поддерживает транзакции, но имеет ограниченную поддержку уровней изоляции. По умолчанию используется уровень, эквивалентный SERIALIZABLE.

```sql
-- В SQLite нет оператора для установки уровня изоляции
```

## Автоматические транзакции

В некоторых СУБД (например, PostgreSQL) каждый отдельный оператор SQL выполняется в рамках неявной транзакции. Это называется "автоматическим режимом фиксации" (autocommit).

Чтобы отключить автоматическую фиксацию и начать явную транзакцию:

```sql
-- PostgreSQL
SET autocommit = OFF;

-- MySQL
SET autocommit = 0;
```

## Практические рекомендации по работе с транзакциями

1. **Минимизируйте время выполнения транзакций.** Длительные транзакции могут блокировать другие транзакции и снижать производительность системы.

2. **Избегайте интерактивных транзакций.** Не начинайте транзакцию, затем ждите ввода пользователя, затем завершайте транзакцию.

3. **Обрабатывайте ошибки.** Всегда обрабатывайте ошибки и явно выполняйте ROLLBACK при необходимости.

4. **Используйте подходящий уровень изоляции.** Выбирайте минимальный уровень изоляции, который обеспечивает необходимую согласованность данных.

5. **Будьте осторожны с взаимоблокировками.** Старайтесь всегда блокировать ресурсы в одном и том же порядке.

## Транзакции и производительность

Транзакции могут влиять на производительность базы данных:

- Высокие уровни изоляции требуют более сложных механизмов блокировки, что может снизить параллелизм и производительность.
- Длительные транзакции могут блокировать ресурсы на продолжительное время.
- Частые транзакции с небольшим количеством операций могут создавать дополнительную нагрузку на СУБД.

Для оптимизации производительности:
- Выбирайте подходящий уровень изоляции.
- Минимизируйте время выполнения транзакций.
- Объединяйте связанные операции в одну транзакцию.

## Заключение

Транзакции — это фундаментальный механизм баз данных для обеспечения целостности и согласованности данных. Они позволяют группировать несколько операций в логическую единицу работы, обеспечивая атомарность, согласованность, изолированность и долговечность (ACID).

Правильное использование транзакций и выбор подходящего уровня изоляции имеют решающее значение для разработки надежных и производительных приложений, работающих с базами данных.

В следующем уроке мы изучим представления (views), которые позволяют создавать виртуальные таблицы на основе запросов и упрощают работу с базой данных.