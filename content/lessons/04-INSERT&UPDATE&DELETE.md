# Урок 4: INSERT/UPDATE/DELETE - Модификация данных

## Введение

До этого момента мы изучали, как извлекать данные из базы данных. Теперь пришло время узнать, как изменять данные в базе данных. В SQL для этого используются три основных оператора:

- `INSERT` — для добавления новых строк
- `UPDATE` — для изменения существующих строк
- `DELETE` — для удаления строк

Эти операторы вместе с `SELECT` составляют основу CRUD-операций (Create, Read, Update, Delete), которые являются базовыми для работы с любой базой данных.

## Оператор INSERT

Оператор `INSERT` используется для добавления новых строк в таблицу.

### Синтаксис INSERT

Существует два основных синтаксиса:

```sql
-- Синтаксис с явным указанием столбцов
INSERT INTO таблица (столбец1, столбец2, ...)
VALUES (значение1, значение2, ...);

-- Синтаксис без указания столбцов (значения должны быть предоставлены для всех столбцов в том порядке, в котором они определены в таблице)
INSERT INTO таблица
VALUES (значение1, значение2, ...);
```

### Примеры INSERT

```sql
-- Добавление нового клиента с явным указанием столбцов
INSERT INTO customers (first_name, last_name, email, city, country)
VALUES ('Елена', 'Смирнова', 'elena@example.com', 'Казань', 'Россия');

-- Добавление нового товара без явного указания столбцов
INSERT INTO products
VALUES (6, 'Наушники Sony', 'Беспроводные наушники с шумоподавлением', 15000, 'Электроника');
```

### Добавление нескольких строк

Можно добавить несколько строк за один запрос:

```sql
INSERT INTO customers (first_name, last_name, email, city, country)
VALUES 
  ('Павел', 'Федоров', 'pavel@example.com', 'Новосибирск', 'Россия'),
  ('Ольга', 'Кузнецова', 'olga@example.com', 'Екатеринбург', 'Россия');
```

### INSERT с SELECT

Можно использовать результаты запроса `SELECT` для вставки данных:

```sql
-- Копирование клиентов из России в таблицу russian_customers
INSERT INTO russian_customers (first_name, last_name, email, city)
SELECT first_name, last_name, email, city
FROM customers
WHERE country = 'Россия';
```

## Оператор UPDATE

Оператор `UPDATE` используется для изменения существующих строк в таблице.

### Синтаксис UPDATE

```sql
UPDATE таблица
SET столбец1 = значение1, столбец2 = значение2, ...
WHERE условие;
```

**Важно!** Если вы не укажете условие `WHERE`, то изменения будут применены ко всем строкам таблицы.

### Примеры UPDATE

```sql
-- Изменение цены одного товара
UPDATE products
SET price = 42000
WHERE id = 1;

-- Применение скидки 10% ко всем товарам в категории "Электроника"
UPDATE products
SET price = price * 0.9
WHERE category = 'Электроника';

-- Изменение нескольких полей одновременно
UPDATE customers
SET city = 'Санкт-Петербург', country = 'Россия'
WHERE id = 3;
```

### UPDATE с подзапросами

Можно использовать подзапросы в условии `WHERE`:

```sql
-- Изменение статуса всех заказов для клиентов из США
UPDATE orders
SET status = 'Shipped'
WHERE customer_id IN (SELECT id FROM customers WHERE country = 'США');
```

## Оператор DELETE

Оператор `DELETE` используется для удаления строк из таблицы.

### Синтаксис DELETE

```sql
DELETE FROM таблица
WHERE условие;
```

**Важно!** Если вы не укажете условие `WHERE`, то будут удалены все строки таблицы.

### Примеры DELETE

```sql
-- Удаление одного товара
DELETE FROM products
WHERE id = 5;

-- Удаление всех товаров в категории "Книги"
DELETE FROM products
WHERE category = 'Книги';

-- Удаление клиентов, у которых нет заказов
DELETE FROM customers
WHERE id NOT IN (SELECT customer_id FROM orders);
```

## TRUNCATE TABLE

Если вам нужно удалить все строки из таблицы, можно использовать оператор `TRUNCATE TABLE`:

```sql
TRUNCATE TABLE таблица;
```

`TRUNCATE TABLE` обычно работает быстрее, чем `DELETE FROM таблица` без условия `WHERE`, так как он не записывает информацию об удалении каждой строки в журнал. Однако `TRUNCATE TABLE` нельзя использовать с условием `WHERE`.

## Транзакции

При выполнении операций модификации данных важно понимать концепцию транзакций. Транзакция — это набор операций, которые выполняются как одно целое: либо все операции выполняются успешно, либо ни одна из них.

```sql
-- Начало транзакции
BEGIN TRANSACTION;

-- Операции модификации данных
UPDATE accounts SET balance = balance - 1000 WHERE id = 1;
UPDATE accounts SET balance = balance + 1000 WHERE id = 2;

-- Если все операции выполнены успешно, фиксируем изменения
COMMIT;

-- Если возникла ошибка, отменяем все изменения
ROLLBACK;
```

Более подробно транзакции будут рассмотрены в отдельном уроке.

## Возвращаемые значения

В некоторых СУБД (например, PostgreSQL) операторы модификации данных могут возвращать значения:

```sql
-- Вернуть ID добавленной строки
INSERT INTO products (name, price, category)
VALUES ('Планшет iPad', 35000, 'Электроника')
RETURNING id;

-- Вернуть измененные строки
UPDATE products
SET price = price * 1.1
WHERE category = 'Электроника'
RETURNING id, name, price;

-- Вернуть удаленные строки
DELETE FROM products
WHERE price < 1000
RETURNING *;
```

## Практические примеры CRUD-операций

Давайте рассмотрим полный набор CRUD-операций для управления информацией о клиентах:

### Create (Создание)

```sql
-- Добавление нового клиента
INSERT INTO customers (first_name, last_name, email, city, country)
VALUES ('Дмитрий', 'Николаев', 'dmitry@example.com', 'Владивосток', 'Россия');
```

### Read (Чтение)

```sql
-- Получение информации о клиенте
SELECT * FROM customers WHERE id = 6;

-- Получение списка всех клиентов из России
SELECT * FROM customers WHERE country = 'Россия';
```

### Update (Обновление)

```sql
-- Изменение адреса электронной почты клиента
UPDATE customers
SET email = 'dmitry.nikolaev@example.com'
WHERE id = 6;
```

### Delete (Удаление)

```sql
-- Удаление клиента
DELETE FROM customers
WHERE id = 6;
```

## Обеспечение целостности данных

При модификации данных важно обеспечивать их целостность. Вот несколько аспектов, о которых следует помнить:

### Первичные ключи

Первичный ключ (PRIMARY KEY) обеспечивает уникальность строк в таблице. При вставке новых строк нужно следить, чтобы значения первичного ключа не дублировались.

### Внешние ключи

Внешний ключ (FOREIGN KEY) обеспечивает связь между таблицами. Например, если в таблице `orders` есть поле `customer_id`, которое ссылается на поле `id` в таблице `customers`, нельзя добавить заказ с `customer_id`, которого нет в таблице `customers`.

### Ограничения NOT NULL

Если столбец имеет ограничение NOT NULL, то при вставке или обновлении нельзя установить для него значение NULL.

### Ограничения UNIQUE

Если на столбец наложено ограничение UNIQUE, то значения в этом столбце должны быть уникальными. Например, поле `email` в таблице `customers` часто делают уникальным.

## Заключение

В этом уроке мы изучили основные операторы модификации данных в SQL: `INSERT`, `UPDATE` и `DELETE`. Эти операторы позволяют добавлять новые строки, изменять существующие и удалять ненужные строки из таблиц базы данных.

Важно помнить о необходимости указывать условие `WHERE` в операторах `UPDATE` и `DELETE`, чтобы изменения затрагивали только нужные строки. Также следует учитывать ограничения целостности данных, такие как первичные и внешние ключи.

В следующем уроке мы изучим агрегационные функции, которые позволяют выполнять статистические расчеты по группам данных.