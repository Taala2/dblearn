# Урок 3: ORDER BY, LIMIT - Сортировка и ограничение результатов

## Введение в ORDER BY

После того как мы научились извлекать и фильтровать данные, следующий важный шаг - научиться упорядочивать результаты запроса. Для этого в SQL используется оператор `ORDER BY`.

Базовый синтаксис оператора `ORDER BY`:

```sql
SELECT столбец1, столбец2, ...
FROM таблица
WHERE условие
ORDER BY столбец1 [ASC|DESC], столбец2 [ASC|DESC], ...;
```

## Сортировка по одному столбцу

По умолчанию `ORDER BY` сортирует данные по возрастанию (ASC). Если вам нужно отсортировать по убыванию, используйте ключевое слово `DESC`.

```sql
-- Сортировка товаров по цене (от низкой к высокой)
SELECT *
FROM products
ORDER BY price;

-- Сортировка товаров по цене (от высокой к низкой)
SELECT *
FROM products
ORDER BY price DESC;
```

## Сортировка по нескольким столбцам

Вы можете сортировать результаты по нескольким столбцам. В этом случае сначала будет применена сортировка по первому указанному столбцу, затем, если есть строки с одинаковыми значениями первого столбца, они будут отсортированы по второму столбцу и т.д.

```sql
-- Сортировка клиентов сначала по стране, затем по городу
SELECT *
FROM customers
ORDER BY country, city;

-- Сортировка товаров сначала по категории, затем по цене (от высокой к низкой)
SELECT *
FROM products
ORDER BY category, price DESC;
```

## Сортировка по выражениям и псевдонимам

Вы можете сортировать результаты не только по столбцам таблицы, но и по вычисляемым выражениям или псевдонимам:

```sql
-- Сортировка товаров по цене со скидкой
SELECT name, price, price * 0.9 AS discounted_price
FROM products
ORDER BY discounted_price;

-- Сортировка клиентов по длине имени
SELECT first_name, last_name
FROM customers
ORDER BY LENGTH(first_name);
```

## Сортировка с использованием порядковых номеров столбцов

Вместо имен столбцов в `ORDER BY` можно использовать их порядковые номера в списке выборки:

```sql
SELECT name, price
FROM products
ORDER BY 2 DESC; -- Сортировка по второму столбцу (price) по убыванию
```

Этот метод не рекомендуется использовать в реальных проектах, так как он делает запрос менее понятным и более подверженным ошибкам при изменении списка выборки.

## Оператор LIMIT

Оператор `LIMIT` позволяет ограничить количество строк, возвращаемых запросом. Это полезно, когда вам нужны только первые несколько результатов или когда вы реализуете постраничный вывод данных.

Базовый синтаксис оператора `LIMIT`:

```sql
SELECT столбец1, столбец2, ...
FROM таблица
WHERE условие
ORDER BY столбец
LIMIT количество [OFFSET смещение];
```

## Получение первых N строк

Чтобы получить только первые N строк из результата запроса, используйте `LIMIT N`:

```sql
-- Получить 3 самых дорогих товара
SELECT *
FROM products
ORDER BY price DESC
LIMIT 3;
```

## Постраничный вывод с LIMIT и OFFSET

Для реализации постраничного вывода используйте `LIMIT` вместе с `OFFSET`. `LIMIT` определяет количество строк на странице, а `OFFSET` - сколько строк нужно пропустить.

```sql
-- Получить товары со 2-й страницы (по 2 товара на странице)
SELECT *
FROM products
ORDER BY name
LIMIT 2 OFFSET 2;
```

В этом примере мы пропускаем первые 2 товара (OFFSET 2) и берем следующие 2 товара (LIMIT 2), что соответствует второй странице при отображении по 2 товара на странице.

## Альтернативный синтаксис LIMIT с OFFSET

В некоторых СУБД (например, MySQL) можно использовать альтернативный синтаксис `LIMIT [смещение], [количество]`:

```sql
SELECT *
FROM products
ORDER BY name
LIMIT 2, 2; -- эквивалентно LIMIT 2 OFFSET 2
```

Однако этот синтаксис менее понятен и поддерживается не во всех СУБД, поэтому рекомендуется использовать стандартный синтаксис `LIMIT ... OFFSET ...`.

## Объединение ORDER BY, WHERE и LIMIT

Все эти операторы можно комбинировать в одном запросе, но важно соблюдать правильный порядок:

```sql
SELECT name, price, category
FROM products
WHERE price > 1000
ORDER BY price DESC
LIMIT 5;
```

Этот запрос выберет товары дороже 1000, отсортирует их по цене от высокой к низкой и вернет только первые 5 результатов.

## Порядок выполнения операторов

Порядок операторов в запросе SQL важен и должен соответствовать следующей последовательности:

1. `SELECT`
2. `FROM`
3. `WHERE`
4. `ORDER BY`
5. `LIMIT`

Сам SQL-запрос выполняется в следующем порядке:

1. `FROM` - определяет таблицу, из которой будут выбираться данные
2. `WHERE` - фильтрует строки по указанному условию
3. `SELECT` - выбирает указанные столбцы
4. `ORDER BY` - сортирует результаты
5. `LIMIT` - ограничивает количество возвращаемых строк

## Примеры использования

### Топ-N запросы

Топ-N запросы - это запросы, которые возвращают N строк с наибольшими или наименьшими значениями некоторого столбца.

```sql
-- Топ-3 самых дорогих товара
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3;

-- Топ-5 самых дешевых товаров
SELECT name, price
FROM products
ORDER BY price
LIMIT 5;
```

### Поиск медианы

Чтобы найти медиану (значение, которое находится посередине отсортированного набора данных), можно использовать `LIMIT` и `OFFSET`:

```sql
-- Найти медианную цену товаров (предполагается, что всего 9 товаров)
SELECT price
FROM products
ORDER BY price
LIMIT 1 OFFSET 4; -- Средний элемент в отсортированном наборе из 9 элементов
```

### Постраничный вывод

Для реализации постраничного вывода используйте `LIMIT` и `OFFSET`:

```sql
-- Страница 1 (элементы 1-10)
SELECT *
FROM products
ORDER BY name
LIMIT 10 OFFSET 0;

-- Страница 2 (элементы 11-20)
SELECT *
FROM products
ORDER BY name
LIMIT 10 OFFSET 10;

-- Страница 3 (элементы 21-30)
SELECT *
FROM products
ORDER BY name
LIMIT 10 OFFSET 20;
```

## Заключение

В этом уроке мы изучили операторы `ORDER BY` и `LIMIT`, которые позволяют сортировать результаты запросов и ограничивать количество возвращаемых строк. Мы научились сортировать данные по одному или нескольким столбцам, использовать сортировку по убыванию, а также применять `LIMIT` и `OFFSET` для постраничного вывода и топ-N запросов.

В следующем уроке мы изучим операторы модификации данных: `INSERT`, `UPDATE` и `DELETE`, которые позволяют добавлять, изменять и удалять данные в таблицах.